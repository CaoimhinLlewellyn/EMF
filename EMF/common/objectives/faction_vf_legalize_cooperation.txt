
faction_vf_legalize_cooperation = {
	type = liege_titles
	
	warning_level = 1.0
	
	# Plotter scope (faction leader)
	potential = {
		prisoner = no
		is_ruler = yes
		is_adult = yes
		independent = no
		is_landed = yes
		higher_tier_than = baron
		not = { trait = incapable }
		
		liege = {
			higher_real_tier_than = duke
			is_merchant_republic = no # Theocratic and feudal lieges are OK
			
			or = { # No early intra-tribal factions
				year = 1350
				primary_title = { is_tribal_type_title = no }
				not = { culture = ROOT }
				not = { religion = ROOT }
			}
			or = { # No unreformed pagans
				not = { religion_group = pagan_group }
				is_reformed_religion = yes
			}
			not = { # No temporary titles in liege's demesne
				any_demesne_title = {
					temporary = yes
				}
			}
		}
	}
	
	# Target scope (ROOT = target [a liege title], FROM = plotter [vassal character])
	allow = {
		# Primary title only
		is_primary_holder_title = yes

		# Currently, must be a crown-level title
		higher_tier_than = duke

		# No temporaries, mercs, or holy orders
		temporary = no
		holy_order = no
		mercenary = no

		# Vassal cooperation banned
		not = {
			has_law = vf_cooperation_1
			has_law = vf_cooperation_2
			has_law = vf_cooperation_3
		}

		holder_scope = {
			not = {
				any_war = {
					war_title = ROOT
					using_cb = vf_legalize_cooperation
				}
			}

			not = {
				reverse_has_opinion_modifier = {
					who = FROM
					modifier = opinion_coerced_into_leaving_faction
				}
			}
		}
	}
	
	# Faction member scope (ROOT = joiner, FROM = target)
	allow_join = {
		ROOT = {
			is_ruler = yes
			is_adult = yes
			is_landed = yes
			higher_tier_than = baron
			independent = no
			prisoner = no
			not = { trait = incapable }
		}
	}
	
	# AI creation weight (FROM is prospective/current faction leader [I think], ROOT is target [liege title])
	chance = {
		factor = 10
		
		# Rule out implausible participants
		modifier = {
			factor = 0
			holder_scope = {
				any_spouse = { character = FROM }
			}
		}
		modifier = {
			factor = 0
			holder_scope = {
				current_heir = {
					character = FROM
					not = { trait = liberal }
				}
			}
		}
		modifier = { # I'd think the potential + allow_join would rule this out, but vanilla checks anyway...
			factor = 0
			FROM = { prisoner = yes }
		}
		modifier = {
			factor = 0
			FROM = { preparing_invasion = yes }
		}
		
		# Must be at least 1 other vassal to be able to join	
		modifier = {
			factor = 0
			holder_scope = {
				not = {
					any_vassal = {
						not = { character = FROM }
						higher_tier_than = baron
						is_adult = yes
						is_landed = yes
						prisoner = no
						not = { trait = incapable }
					}
				}
			}
		}
		
		# Not if they've been coerced into leaving
		modifier = {
			factor = 0
			holder_scope = {
				reverse_has_opinion_modifier = {
					who = FROM
					modifier = opinion_coerced_into_leaving_faction
				}
			}
		}
		
		# Participation more important the bigger the subrealm...
		modifier = {
			factor = 1.15
			FROM = { realm_size = 10 }
		}
		modifier = {
			factor = 1.15
			FROM = { realm_size = 15 }
		}
		modifier = {
			factor = 1.15
			FROM = { realm_size = 20 }
		}
		modifier = {
			factor = 1.15
			FROM = { realm_size = 25 }
		}
		modifier = {
			factor = 1.15
			FROM = { realm_size = 30 }
		}
		modifier = {
			factor = 1.1
			FROM = { realm_size = 35 }
		}
		modifier = {
			factor = 1.1
			FROM = { realm_size = 40 }
		}
		modifier = {
			factor = 1.1
			FROM = { realm_size = 45 }
		}
		modifier = {
			factor = 1.1
			FROM = { realm_size = 50 }
		}
		
		# Favor faction leaders with greater diplomacy...
		modifier = {
			factor = 1.1
			FROM = { diplomacy = 8 }
		}
		modifier = {
			factor = 1.1
			FROM = { diplomacy = 9 }
		}
		modifier = {
			factor = 1.1
			FROM = { diplomacy = 10 }
		}
		modifier = {
			factor = 1.1
			FROM = { diplomacy = 11 }
		}
		modifier = {
			factor = 1.1
			FROM = { diplomacy = 12 }
		}
		
		# Trait bonuses
		modifier = {
			factor = 1.25
			FROM = { trait = ambitious }
		}
		modifier = {
			factor = 1.25
			FROM = { trait = brave }
		}
		modifier = {
			factor = 1.25
			FROM = { trait = just }
		}
		modifier = {
			factor = 1.5
			FROM = { trait = liberal }
		}
		modifier = {
			factor = 1.25
			FROM = { trait = proud }
		}
		
		# Trait maluses
		modifier = {
			factor = 0.2
			FROM = { pacifist = yes }
		}
		modifier = {
			factor = 0.2
			FROM = { trait = content }
		}
		modifier = {
			factor = 0.85
			FROM = { trait = slothful }
		}
		modifier = {
			factor = 0.5
			FROM = { trait = craven }
		}
		modifier = {
			factor = 0.75
			FROM = { trait = conservative }
		}
		modifier = {
			factor = 0.9
			FROM = { trait = humble }
		}

		# NOTE: Opinion is completely ignored for this faction's leadership. The leader of this faction,
		# if successful, has a good shot at becoming the first VF leader, and there is no reason to
		# encourage leaders that hate the liege. This faction is no conspiracy but a matter of making it legal
		# for the VF to meet and collectively cooperate in measures they deem fit without incurring any
		# penalties or chance thereof.
	}
	
	# AI membership weight: ROOT is the prospective member. FROM is the faction leader. FROMFROM is the target title or character.
	membership = {
		factor = 10

		modifier = {
			factor = 0
			or = {
				prisoner = yes
				trait = incapable
				is_adult = no
				tier = baron
				is_landed = no
				preparing_invasion = yes
			}
		}
		
		modifier = {
			factor = 0
			not = { trait = liberal }
			not = {
				has_opinion_modifier = {
					who = FROM
					modifier = opinion_coerced_into_joining_faction
				}
			}
			FROMFROM = {
				current_heir = {
					character = ROOT
				}
			}
		}
		
		modifier = {
			factor = 0
			liege = { 
				not = { year = 1350 }
				primary_title = { is_tribal_type_title = yes }
				culture = ROOT
				religion = ROOT
			}
		}
		
		# Slow it down for high opinions
		modifier = {
			factor = 0.8
			opinion = { who = liege value = 100 }
		}
		modifier = {
			factor = 0.9
			opinion = { who = liege value = 90 }
		}
		modifier = {
			factor = 0.9
			opinion = { who = liege value = 80 }
		}
		modifier = {
			factor = 0.9
			opinion = { who = liege value = 70 }
		}
		modifier = {
			factor = 0.9
			opinion = { who = liege value = 60 }
		}
		
		modifier = {
			factor = 2
			trait = liberal
		}
		modifier = {
			factor = 0.5
			trait = conservative
		}
		modifier = {
			factor = 0.75
			trait = craven
		}
		modifier = {
			factor = 0.5
			trait = content
		}
		
		modifier = {
			factor = 0
			has_opinion_modifier = {
				who = liege
				modifier = opinion_coerced_into_leaving_faction
			}
		}
		
		modifier = {
			factor = 1000
			has_opinion_modifier = {
				who = FROM
				modifier = opinion_coerced_into_joining_faction
			}
		}
	}
	
	success = {
		or = {
			has_law = vf_cooperation_1
			has_law = vf_cooperation_2
			has_law = vf_cooperation_3
		}
	}
	
	abort = {
		always = no		# Factions will abort if the Potential or Allow triggers are no longer valid
	}
	
	abort_effect = {
	}
	
	effect = {
		FROM = {
			any_faction_backer = {
				faction = faction_vf_legalize_cooperation
				reverse_opinion = {
					modifier = opinion_grateful
					who = FROM
					years = 5
				}
			}
		}
	}
}
