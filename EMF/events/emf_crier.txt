namespace = emf_crier

# Hear ye, hear ye...
# "A lie can run round the world before the truth has got its boots on."

# Should also add chronicle entries for this stuff

## Will eventually cover:
# Deaths:
# Unusual deaths for religion heads
# Deaths of Emperors
# Deaths of players in MP

### DEATH EVENTS

## Death Listener Mechanic
## 0-49 Reserved
# Death Proxy - from on_death
character_event = {
	id = emf_crier.0
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		or = {
			# real_tier = EMPEROR
			and = {
				controls_religion = yes
				or = {
					religion_group = christian
					# Insert other religion groups here
				}
			}
			and = {
				ai = no
				multiplayer = yes
			}
		}
	}

	immediate = {
		# Player death mechanic
		if = {
			limit = {
				ai = no
				multiplayer = yes
			}
			character_event = { id = emf_crier.200 }
		}
		# Handle MA changes
		if = {
			limit = { controls_religion = yes }
			e_hip = {
				owner = {
					character_event = { id = emf_crier.1 days = 1 }
				}
			}
		}
		# Send Isis bounce events
		# if = { # Emperor version gets priority
			# limit = { real_tier = EMPEROR }
			# if = { # Also controls religion
				# limit = { controls_religion = yes }
				# e_hip = {
					# owner = {
						# character_event = { id = emf_crier.2 days = 1 }
					# }
				# }
				# break = yes
			# }
			# e_hip = {
				# owner = {
					# character_event = { id = emf_crier.3 days = 1 }
				# }
			# }
			# break = yes
		# }
		if = { # Religious heads come next
			limit = { controls_religion = yes }
			e_hip = {
				owner = {
					character_event = { id = emf_crier.4 days = 1 }
				}
			}
			break = yes
		}
	}
	
	option = {
		name = OK
	}
}

# Isis giveth and Isis taketh away
character_event = {
	id = emf_crier.1
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		log = "Isis got MA event"
		FROM = { # MA changes
			if = { # RelHead was sacrificed
				limit = { death_reason = death_sacrificed }
				religion_authority = {
					modifier = religion_head_sacrificed
					years = 50
				}
				log = "Isis took MA from [This.Religion.GetName] faith"
				if = { # Killer was different religion
					limit = {
						killer = {
							not = { religion = FROM }
						}
					}
					killer = {
						religion_authority = {
							modifier = sacrificed_other_religion_head
							years = 50
						}
						log = "Isis gave MA to [This.Religion.GetName] faith"
					}
				}
			}
		}
	}
	
	option = {
		name = OK
	}
}

# Isis bounce event for emperors who are religion heads
character_event = {
	id = emf_crier.2
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		log = "Isis got emperor/relhead event"
	}
	
	option = {
		name = OK
	}
}

# Isis bounce event for emperors
character_event = {
	id = emf_crier.3
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		log = "Isis got emperor event"
	}
	
	option = {
		name = OK
	}
}

# Isis bounce event for religious heads
character_event = {
	id = emf_crier.4
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			is_alive = no
			killer = { always = yes } # Right now this only works when there's a killer, might change in future
		}
	}
	
	immediate = {
		log = "Isis got relhead event"
		FROM = {
			if = { # Leader was sacrificed by other faith
				limit = {
					death_reason = death_sacrificed
					killer = {
						not = { religion = FROM }
					}
				}
				killer = {
					narrative_event = { id = emf_crier.50 } # Delay?
				}
				break = yes
			}
		}
	}
	
	option = {
		name = OK
	}
}

# DEATH FLAVOR NOTES:
# Different flavor depending on religion, might not send to parties who wouldn't care, might use distance as a factor, should have special flavor and rewards for the one who sacrificed (accessed through killer = {} scope), will have minor mechanics such as making Catholic folks hate the character who killed the Pope or reducing the authority of the religion whose leader was sacrificed, etc

# Localization might be changed for specific peculiarities of FROMFROM's religion. For example, some folks might have different ideas about what it means for their religious leader to die in battle
# If so, that will be built into the desc and option triggers rather than doing unique events

## Religion Head Death Flavor
## 50-99 Reserved
# Former religion head was sacrificed by other faith
# ROOT = killer, FROMFROM = Sacrificed leader
narrative_event = {
	id = emf_crier.50
	title = emf_crier.50.title
	# Killer = Norse
	desc = { # Killer
		text = emf_crier.50.desc_norse_killer
		trigger = {
			character = ROOT
			or = {
				religion = norse_pagan
				religion = norse_pagan_reformed
			}
		}
	}
	desc = { # Killer's Faith
		text = emf_crier.50.desc_norse_faith
		trigger = {
			not = { character = ROOT }
			religion = ROOT
			or = {
				religion = norse_pagan
				religion = norse_pagan_reformed
			}
		}
	}
	# Killer = Hindu
	# Killer = Zun
	# Killer = Aztec
	desc = { # Sacrifice's religion
		text = emf_crier.50.desc_sacrifice
		trigger = {
			religion = FROMFROM
			not = { religion = ROOT }
		}
	}
	desc = { # Others in FROMFROM's group
		text = emf_crier.50.desc_group
		trigger = {
			religion_group = FROMFROM
			not = { religion = FROMFROM }
			not = { religion = ROOT }
		}
	}
	desc = { # Other religions
		text = emf_crier.50.desc_other
		trigger = {
			not = { religion_group = FROMFROM }
			not = { religion = ROOT }
		}
	}
	picture = GFX_evt_cathedral
	is_triggered_only = yes
	major = yes
	show_ROOT = yes
	show_from_from = yes
	
	major_trigger = {
		is_playable = yes
	}
	
	option = { # Dummy failsafe option, will be removed later
		trigger = { always = no }
		name = OK
		set_character_flag = someone_is_a_dummy
	}
	option = { # The RelHead Killer
		trigger = { character = ROOT }
		name = emf_crier.50.a

		piety = 100
		prestige = 100
		tooltip = {
			religion_authority = {
				modifier = sacrificed_other_religion_head
				years = 50
			}
		}
	}
	option = { # The Killer's faith
		trigger = {
			not = { character = ROOT }
			religion = ROOT
		}
		name = emf_crier.50.b
	}
	option = { # The sacrifice's faith responds
		trigger = {
			religion = FROMFROM
			not = { religion = ROOT }
		}
		name = emf_crier.50.c

		if = {
			limit = { controls_religion = yes }
			add_rival = ROOT # Is this even necessary?
		}
		opinion = {
			modifier = opinion_sacrificed_religion_head
			who = ROOT
			months = 600
		}
		tooltip = {
			religion_authority = {
				modifier = religion_head_sacrificed
				years = 50
			}
		}
	}
	option = { # Others in FROMFROM's group
		trigger = {
			religion_group = FROMFROM
			not = { religion = FROMFROM }
			not = { religion = ROOT }
		}
		name = emf_crier.50.d
	}
	option = { # Other religions
		trigger = {
			not = { religion_group = FROMFROM }
			not = { religion = ROOT }
		}
		name = emf_crier.50.e
	}
}

# Former religion head was sacrificed by own faith?
# Former religion head was executed
# Former religion head was murdered
# Former religion head died in battle
# Former religion head died in a duel

## 100-149 Reserved for potential expansion

## Emperor Death Flavor
## 150-199 Reserved

## Player Death Flavor
## 200-249 Reserved
# Notification handler
# Eventually might put flavorful chronicle entries into other player's chronicles?
character_event = {
	id = emf_crier.200
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		any_playable_ruler = {
			limit = {
				ai = no
				not = { character = ROOT }
			}
			character_event = { id = emf_crier.201 }
		}
	}
	
	option = {
		name = OK
	}
}

# Notify other players of a fellow player's death
character_event = {
	id = emf_crier.201
	desc = emf_crier.201.desc
	picture = GFX_evt_death
	is_triggered_only = yes
	notification = yes
	
	option = {
		name = OK
	}
}

## 250-499 Free

### TITLE EVENTS

## Will eventually cover:
# Titles:
# Formation of new empires (if they don't already have announcement)
# Formation of new kingdoms within distance limits (400 or so?) (if they don't already have announcement)
# Destruction of empires
# Loss of holy site control

## New Titles
## 500-549 Reserved
# Title listener - from on_new_holder
# ROOT is the character, FROM is the title, FROMFROM is the old holder
character_event = {
	id = emf_crier.500
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			title = FROMFROM # Because if there was no previous holder FROMFROM is the title
			rebel = no
			temporary = no
			is_primary_holder_title = yes
			or = {
				and = {
					tier = EMPEROR
					not = {
						title = e_hre
						title = e_roman_empire
					}
				}
				# and = {
					# tier = KING
					# not = {
						# title = k_israel
						# title = k_leon
						# title = k_hungary
					# }
				# }
			}
		}
	}
	
	option = { # New empire
		trigger = {
			FROM = { tier = EMPEROR }
		}
		name = OK
		
		narrative_event = { id = emf_crier.501 }
	}
	
	option = { # New kingdom
		trigger = {
			FROM = { tier = KING }
		}
		name = OK
	}
}

# Announce new empire
# ROOT = owner, FROMFROM = title
narrative_event = {
	id = emf_crier.501
	title = emf_crier.501.title
	desc = {
		text = emf_crier.501.desc_owner
		trigger = { has_landed_title = FROMFROM }
	}
	desc = { # Nearby rulers of same religion
		text = emf_crier.501.desc_nearby_samerel
		trigger = {
			not = { has_landed_title = FROMFROM }
			religion = ROOT
			capital_scope = {
				ROOT = {
					capital_scope = {
						not = {
							distance = {
								where = PREVPREV
								distance = 400
							}
						}
					}
				}
			}
		}
	}
	desc = { # Nearby rulers of different religion
		text = emf_crier.501.desc_nearby_difrel
		trigger = {
			not = { has_landed_title = FROMFROM }
			not = { religion = ROOT }
			capital_scope = {
				ROOT = {
					capital_scope = {
						not = {
							distance = {
								where = PREVPREV
								distance = 400
							}
						}
					}
				}
			}
		}
	}
	desc = { # Distant rulers of same religion
		text = emf_crier.501.desc_distant_samerel
		trigger = {
			not = { has_landed_title = FROMFROM }
			religion = ROOT
			capital_scope = {
				ROOT = {
					capital_scope = {
						distance = {
							where = PREVPREV
							distance = 400
						}
					}
				}
			}
		}
	}
	desc = { # Distant rulers of different religion
		text = emf_crier.501.desc_distant_difrel
		trigger = {
			not = { has_landed_title = FROMFROM }
			not = { religion = ROOT }
			capital_scope = {
				ROOT = {
					capital_scope = {
						distance = {
							where = PREVPREV
							distance = 400
						}
					}
				}
			}
		}
	}
	picture = GFX_evt_coronation
	is_triggered_only = yes
	major = yes
	# show_ROOT = yes
	# show_from_from = yes
	
	major_trigger = {
		is_playable = yes
	}
	
	option = { # Dummy failsafe option, will be removed later
		trigger = { always = no }
		name = OK
		set_character_flag = someone_is_a_dummy
	}
	option = {
		trigger = { has_landed_title = FROMFROM }
		name = emf_crier.501.a
	}
	option = { # Nearby rulers of same religion
		trigger = {
			not = { has_landed_title = FROMFROM }
			religion = ROOT
			capital_scope = {
				ROOT = {
					capital_scope = {
						not = {
							distance = {
								where = PREVPREV
								distance = 400
							}
						}
					}
				}
			}
		}
		name = emf_crier.501.b
	}
	option = { # Nearby rulers of different religion
		trigger = {
			not = { has_landed_title = FROMFROM }
			not = { religion = ROOT }
			capital_scope = {
				ROOT = {
					capital_scope = {
						not = {
							distance = {
								where = PREVPREV
								distance = 400
							}
						}
					}
				}
			}
		}
		name = emf_crier.501.c
	}
	option = { # Distant rulers of same religion
		trigger = {
			not = { has_landed_title = FROMFROM }
			religion = ROOT
			capital_scope = {
				ROOT = {
					capital_scope = {
						distance = {
							where = PREVPREV
							distance = 400
						}
					}
				}
			}
		}
		name = emf_crier.501.d
	}
	option = { # Distant rulers of different religion
		trigger = {
			not = { has_landed_title = FROMFROM }
			not = { religion = ROOT }
			capital_scope = {
				ROOT = {
					capital_scope = {
						distance = {
							where = PREVPREV
							distance = 400
						}
					}
				}
			}
		}
		name = emf_crier.501.e
	}
}

# Announce new kingdom
# ROOT = owner, FROMFROM = title
# 502 reserved

# Announce empire destruction
# FROM = holder, event_target:emf_crier_dead_title = title
narrative_event = {
	id = emf_crier.503
	title = emf_crier.503.title
	desc = { # Not HRE, ERE
		text = emf_crier.503.desc
		trigger = {
			event_target:emf_crier_dead_title = {
				not = {
					title = e_hre
					title = e_byzantium
				}
			}
		}
	}
	desc = { # HRE
		text = emf_crier.503.desc_hre
		trigger = {
			event_target:emf_crier_dead_title = { title = e_hre }
		}
	}
	desc = { # ERE
		text = emf_crier.503.desc_byz
		trigger = {
			event_target:emf_crier_dead_title = { title = e_byzantium }
		}
	}
	picture = GFX_evt_shadowy_cabal
	is_triggered_only = yes
	
	option = { # Dummy failsafe option, will be removed later
		trigger = { always = no }
		name = OK
		set_character_flag = someone_is_a_dummy
	}
	option = {
		trigger = { religion = FROM }
		name = CURSES
	}
	option = {
		trigger = {
			not = { religion = FROM }
			religion_group = FROM
		}
		name = OK
	}
	option = {
		trigger = {
			not = { religion_group = FROM }
		}
		name = EXCELLENT
	}
}
