
namespace = emf_empires


# emf_empires.0
# Determine if an empire needs to be dismantled due to decline
#
# MTTH event rather than annual pulse so that the 'war = no'
# requirement doesn't prevent empires from being dissolved
# for potentially many years on end.
character_event = {
	id = emf_empires.0
	desc = emf_empires.0.desc
	picture = GFX_evt_bad_news
	border = GFX_event_normal_frame_war
	
	only_independent = yes
	
	trigger = {
		tier = emperor
		war = no
		had_global_flag = { flag = EMF days = 10950 } # First 30yr of campaign
		any_demesne_title = {
			tier = emperor
			temporary = no
			is_landless_type_title = no
			is_tribal_type_title = no
			rebel = no
			or = {
				and = {
					ROOT = { not = { realm_size = 100 } }
					not = {
						title = e_hip
						title = e_rebels
						title = e_pirates
						title = e_byzantium
						title = e_roman_empire
						title = e_latin_empire
						title = e_timurids
						title = e_mexikha
						and = {
							or = {
								title = e_golden_horde
								title = e_il-khanate
							}
							ROOT = { religion = tengri_pagan }
						}
					}
				}
				and = {
					year = 1100
					ROOT = { not = { realm_size = 150 } }
					title = e_hre
				}
				and = {
					or = {
						title = e_byzantium
						title = e_latin_empire
					}
					not = { c_byzantion = { owner = { same_realm = ROOT } } }
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = { # If we don't have another empire or king title to fallback upon...
			limit = {
				not = {
					num_of_emperor_titles = 2
					any_demesne_title = {
						tier = king
						temporary = no
					}
				}
			}
			
			# Then we will try to find one...
			
			# First, check capital kingdom for availability
			if = {
				limit = {
					capital_scope = {
						kingdom = {
							has_holder = no
							is_titular = no
						}
					}
				}
				
				# Good. Now determine whether we'd qualify to form it by the 50% rule.
				
				capital_scope = {
					kingdom = {
						any_direct_de_jure_vassal_title = { # Duchies...
							any_direct_de_jure_vassal_title = { # Counties...
								
								if = {
									limit = { owner = { same_realm = ROOT } }
									ROOT = { change_variable = { which = king_counties value = 1 } }
								}
								
								if = {
									limit = { owner = { not = { same_realm = ROOT } } }
									ROOT = { change_variable = { which = king_counties value = -1 } }
								}
								
							}
						}
					}
				}
				
				if = {
					limit = { check_variable = { which = king_counties value = -0.1 } } # 50% rule passes
					
					capital_scope = {
						kingdom = {
							gain_title = ROOT
						}
					}
					
					set_character_flag = found_kingdom
				}
				
				set_variable = { which = king_counties value = 0 } # Toss it
			}
			
			# If not found, check all the de jure kingdoms of any empire titles that ROOT has, if the empire is de jure

			any_demesne_title = { # For all the de jure empires...
				limit = {
					tier = emperor
					is_titular = no
				}
				
				any_direct_de_jure_vassal_title = { # For all the kingdoms...
					limit = {
						not = { ROOT = { has_character_flag = found_kingdom } }
						has_holder = no
						is_titular = no
					}
					
					any_direct_de_jure_vassal_title = { # Duchies...
						any_direct_de_jure_vassal_title = { # Counties...
							
							if = {
								limit = { owner = { same_realm = ROOT } }
								ROOT = { change_variable = { which = king_counties value = 1 } }
							}
							
							if = {
								limit = { owner = { not = { same_realm = ROOT } } }
								ROOT = { change_variable = { which = king_counties value = -1 } }
							}
							
						}
					}
					
					if = {
						limit = { ROOT = { check_variable = { which = king_counties value = -0.1 } } } # 50% rule passes
						
						gain_title = ROOT
						ROOT = { set_character_flag = found_kingdom }
					}
					
					ROOT = { set_variable = { which = king_counties value = 0 } } # Toss it
				}
			}
			
			clr_character_flag = found_kingdom
		}
	}
	
	option = {
		name = emf_empires.0.opt.a

		random_demesne_title = {
			limit = {
				tier = emperor
				temporary = no
				is_landless_type_title = no
				is_tribal_type_title = no
				rebel = no
				or = {
					and = {
						ROOT = { not = { realm_size = 100 } }
						not = {
							title = e_hip
							title = e_rebels
							title = e_pirates
							title = e_byzantium
							title = e_roman_empire
							title = e_latin_empire
							title = e_timurids
							title = e_mexikha
							and = {
								or = {
									title = e_golden_horde
									title = e_il-khanate
								}
								ROOT = { religion = tengri_pagan }
							}
						}
					}
					and = {
						ROOT = { not = { realm_size = 150 } }
						title = e_hre
					}
					and = {
						or = {
							title = e_byzantium
							title = e_latin_empire
						}
						not = { c_byzantion = { owner = { same_realm = ROOT } } }
					}
				}
			}
			
			log = "Automatic Empire Disintegration: Shattered '[This.GetFullName]'"
			#@log = "AED: "Shattered '[This.GetFullName]'"
			
			destroy_landed_title = THIS
		}
		
		prestige = -1200
	}
}


# emf_empires.1
#
# Make sure horde invaders act like horde invaders (trait = conqueror)
# Called from on_actions yearly pulse
character_event = {
	id = emf_empires.1
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	only_independent = yes
	
	trigger = {
		tier = emperor
		not = { trait = conqueror }
		is_adult = yes
		not = { trait = incapable }
		ai = yes
		primary_title = { # Horde invaders
			or = {
				title = e_golden_horde
				title = e_il-khanate
				title = e_timurids
				title = e_mongol_empire
				title = e_mexikha
			}
		}
		or = { # So long as they haven't converted to a non-horde religion
			religion = tengri_pagan
			religion = tengri_pagan_reformed
			religion = aztec
			religion = aztec_reformed
			primary_title = { title = e_timurids }
		}
	}
	
	immediate = {
		add_trait = conqueror
	}

	option = { name = OK }
}


# emf_empires.2
#
# Remove conqueror trait from horde invaders that settle down (or become
# player-controlled or incapable)
#
# Called from on_actions biannual pulse
#
# We only worry about still-independent, still empire-tier rulers,
# because none of the other cases really matter.
character_event = {
	id = emf_empires.2
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	only_independent = yes
	
	trigger = {
		tier = emperor
		trait = conqueror
		or = {
			ai = no
			trait = incapable
			and = {
				or = {
					has_landed_title = e_golden_horde
					has_landed_title = e_il-khanate
					has_landed_title = e_mongol_empire
				}
				not = {
					religion = tengri_pagan
					religion = tengri_pagan_reformed
				}
			}
			and = {
				has_landed_title = e_mexikha
				not = {
					religion = aztec
					religion = aztec_reformed
				}
			}
		}
	}
	
	immediate = {
		remove_trait = conqueror
	}

	option = { name = OK }
}
