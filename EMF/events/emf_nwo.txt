
namespace = emf_nwo


# emf_nwo.0 [Isis]
#
# Put Isis in the FROM scope before interacting with player
character_event = {
	id = emf_nwo.0
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		
		FROM = { narrative_event = { id = emf_nwo.1 } }
	}
}


# emf_nwo.1 [Player]
#
# Would you like independent counts, de jure dukes, or de jure kings?
# Plus explain things a bit and preview the other followup options.
narrative_event = {
	id = emf_nwo.1
	title = emf_nwo.1.title
	desc = emf_nwo.1.desc
	picture = GFX_evt_apocalypto
	is_triggered_only = yes

	option = {
		name = emf_nwo.1.opt.a # Independent Counts
		hidden_tooltip = {
			log = "emf_nwo: Independent Counts (emf_nwo_count)"
			set_global_flag = emf_nwo_count
			FROM = { character_event = { id = emf_nwo.2 } }
		}
	}
	
	option = {
		name = emf_nwo.1.opt.b # De Jure Dukes

		hidden_tooltip = {
			log = "emf_nwo: De Jure Dukes (emf_nwo_duke)"
			set_global_flag = emf_nwo_duke
			FROM = { character_event = { id = emf_nwo.8 } }
		}
	}
	
	option = {
		name = emf_nwo.1.opt.c # De Jure Kings
		
		hidden_tooltip = {
			log = "emf_nwo: De Jure Kings (emf_nwo_king)"
			set_global_flag = emf_nwo_king
			FROM = { character_event = { id = emf_nwo.8 } }
		}
	}
	
	option = {
		name = CANCEL
	}
}


# emf_nwo.2 [Isis]
#
# Bounce
character_event = {
	id = emf_nwo.2
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	option = {
		name = OK
		FROM = { character_event = { id = emf_nwo.3 } }
	}
}


# emf_nwo.3 [Player]
#
# What part of the world do you want to be affected by the New World Order?
# - The Whole World
# - Only Catholic Realms
# - Only Christian Realms
# - Only Muslim Realms
character_event = {
	id = emf_nwo.3
	desc = emf_nwo.3.desc
	is_triggered_only = yes

	option = {
		name = emf_nwo.3.opt.a # The Whole World
		
		hidden_tooltip = {
			FROM = { character_event = { id = emf_nwo.4 } }
		}
	}
	option = {
		name = emf_nwo.3.opt.b # Only Catholic Realms
		
		hidden_tooltip = {
			log = "emf_nwo: Excluding non-Catholic... (emf_nwo_only_catholic)"
			set_global_flag = emf_nwo_only_catholic
			FROM = { character_event = { id = emf_nwo.4 } }
		}
	}
	option = {
		name = emf_nwo.3.opt.c # Only Christian Realms
		
		hidden_tooltip = {
			log = "emf_nwo: Excluding non-Christian... (emf_nwo_only_christian)"
			set_global_flag = emf_nwo_only_christian
			FROM = { character_event = { id = emf_nwo.4 } }
		}
	}
	option = {
		name = emf_nwo.3.opt.d # Only Muslim Realms
		
		hidden_tooltip = {
			log = "emf_nwo: Excluding non-Muslim... (emf_nwo_only_muslim)"
			set_global_flag = emf_nwo_only_muslim
			FROM = { character_event = { id = emf_nwo.6 } } # Skip asking about the Pope
		}
	}
}


# emf_nwo.4 [Isis]
#
# Bounce
character_event = {
	id = emf_nwo.4
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		FROM = { character_event = { id = emf_nwo.5 } }
	}
}


# emf_nwo.5 [Player]
#
# Would you like to spare the Pope's lands?
character_event = {
	id = emf_nwo.5
	desc = OK #FIXME
	is_triggered_only = yes
	
	option = {
		name = YES
		
		hidden_tooltip = {
			log = "emf_nwo: Excluding Papacy... (emf_nwo_spare_pope)"
			set_global_flag = emf_nwo_spare_pope
			FROM = { character_event = { id = emf_nwo.6 } }
		}
	}
	
	option = {
		name = YES
		
		hidden_tooltip = {
			log = "emf_nwo: Excluding Pope... (emf_nwo_spare_pope_only)"
			set_global_flag = emf_nwo_spare_pope_only
			FROM = { character_event = { id = emf_nwo.6 } }
		}
	}
	
	option = {
		name = NO #FIXME: No, free Rome from the Papacy.

		hidden_tooltip = {
			FROM = { character_event = { id = emf_nwo.6 } }
		}
	}
}


# emf_nwo.6 [Isis]
#
# Bounce
character_event = {
	id = emf_nwo.6
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		FROM = { character_event = { id = emf_nwo.7 } }
	}
}


# emf_nwo.7 [Player]
#
# Would you like to leave merchant republics alone?
character_event = {
	id = emf_nwo.7
	desc = OK #FIXME
	is_triggered_only = yes

	option = {
		name = YES
		
		hidden_tooltip = {
			log = "emf_nwo: Excluding merchant republics... (emf_nwo_spare_mr)"
			set_global_flag = emf_nwo_spare_mr
			FROM = { character_event = { id = emf_nwo.20 } }
		}
	}
	
	option = {
		name = NO
		
		hidden_tooltip = {
			FROM = { character_event = { id = emf_nwo.20 } }
		}
	}
}


# emf_nwo.8 [Isis]
#
# Bounce
character_event = {
	id = emf_nwo.8
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		FROM = { character_event = { id = emf_nwo.9 } }
	}
}


# emf_nwo.9 [Player]
#
# For those rulers which already hold de jure [duchies/kingdoms],
# should they remain the [dukes/kings] of their capital [duchies/kingdoms]?
character_event = {
	id = emf_nwo.9
	is_triggered_only = yes
	
	desc = {
		text = emf_nwo.9.desc.duke
		trigger = {
			has_global_flag = emf_nwo_duke
		}
	}
	
	desc = {
		text = emf_nwo.9.desc.king
		trigger = {
			has_global_flag = emf_nwo_king
		}
	}

	option = {
		name = emf_nwo.9.opt.a # Yes, but still make players de jure dukes/kings
		
		hidden_tooltip = {
			log = "emf_nwo: Retaining previous rulers... (emf_nwo_retain_rulers, emf_nwo_retain_rulers_not_me)"
			set_global_flag = emf_nwo_retain_rulers
			set_global_flag = emf_nwo_retain_rulers_not_me
			FROM = { character_event = { id = emf_nwo.2 } }
		}
	}
	
	option = {
		name = emf_nwo.9.opt.b # Yes, even if that makes me a vassal
		
		hidden_tooltip = {
			log = "emf_nwo: Retaining previous rulers... (emf_nwo_retain_rulers)"
			set_global_flag = emf_nwo_retain_rulers
			FROM = { character_event = { id = emf_nwo.2 } }
		}
	}
	
	option = {
		name = NO
		
		hidden_tooltip = {
			FROM = { character_event = { id = emf_nwo.2 } }
		}
	}
}


# 'Would you like to intelligently randomize the religions of the newly formed realms?'
# -> Big Maybe.

# 'Would you like to enable rapid conquest CBs for quicker conglomeration
#  of the new world order? They automatically stop becoming available once
#  a ruler has reached a certain size or tier, and they will be fully disabled
#  in 50 years.'
# - Applies to nwo_count and nwo_duke

# 'Would you like to bless a random selection of independent rulers as Lucky and give them some starting event troops?'
# - Applies to nwo_count and nwo_duke

# 'Would you like to feudalize theocratic and republican counties where possible?'
# -> Maybe. Co
# - Applies to nwo_count 

# Would also ask 'Would you like to feudalize all tribes?' but that should be a scenario customization option of its own


# emf_nwo.20 [Isis]
#
# Now that we have all of our options collected from the player, get down to business.
character_event = {
	id = emf_nwo.20
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	option = {
		name = OK
		
		any_playable_ruler = {
			limit = {
				or = {
					top_liege = { religion = catholic }
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					top_liege = { religion_group = christian }
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					top_liege = { religion_group = muslim }
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			character_event = { id = emf_nwo.23 } # Cleanup state from prior era
		}
		
		# Destroy all the titles that bind. Note that this step, by far, is the most time-consuming of
		# everything that we do in this customization decision.
		
		any_independent_ruler = {
			limit = {
				higher_tier_than = count
				is_landed = yes
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
				or = {
					not = { has_landed_title = k_papal_state }
					not = { has_global_flag = emf_nwo_spare_pope }
				}
				or = {
					is_merchant_republic = no
					not = { has_global_flag = emf_nwo_spare_mr }
				}
			}
			
			# Preserve holy orders, mercs, e_golden_horde, religious head titles,
			# etc., but otherwise, destroy all held duke-tier or higher titles
			# (including temporary titles). This step takes about 2sec on SWMH
			# on my machine at the time of this writing (that is, when it's done
			# for the whole world).
			
			any_title_under = {
				limit = {
					tier = duke
					or = {
						is_landless_type_title = no
						temporary = yes
					}
					or = {
						owner = {
							not = {
								is_merchant_republic = yes
								any_liege = { is_merchant_republic = yes }
							}
						}
						not = { has_global_flag = emf_nwo_spare_mr }
					}
					or = {
						owner = {
							not = {
								has_landed_title = k_papal_state
								any_liege = { has_landed_title = k_papal_state }
							}
						}
						not = { has_global_flag = emf_nwo_spare_pope }
					}
				}
				if = {
					limit = {
						has_global_flag = emf_nwo_duke
						has_global_flag = emf_nwo_retain_rulers
						owner = {
							capital_holding = { de_jure_liege_or_above = PREVPREV }
						}
					}
					owner = {
						set_character_flag = prev_prince
					}
				}
				destroy_landed_title = THIS
			}
			any_title_under = {
				limit = {
					tier = king
					or = {
						is_landless_type_title = no
						temporary = yes
					}
					or = {
						owner = {
							or = {
								is_merchant_republic = no
								not = { any_liege = { is_merchant_republic = yes } }
							}
						}
						not = { has_global_flag = emf_nwo_spare_mr }
					}
					or = {
						owner = {
							not = {
								has_landed_title = k_papal_state
								any_liege = { has_landed_title = k_papal_state }
							}
						}
						not = { has_global_flag = emf_nwo_spare_pope }
					}
				}
				if = {
					limit = {
						has_global_flag = emf_nwo_king
						has_global_flag = emf_nwo_retain_rulers
						owner = {
							capital_holding = { de_jure_liege_or_above = PREVPREV }
						}
					}
					owner = {
						set_character_flag = prev_prince
					}
				}
				destroy_landed_title = THIS
			}
			any_demesne_title = {
				limit = {
					tier = duke
					or = {
						is_landless_type_title = no
						temporary = yes
					}
				}
				if = {
					limit = {
						has_global_flag = emf_nwo_duke
						has_global_flag = emf_nwo_retain_rulers
						owner = {
							capital_holding = { de_jure_liege_or_above = PREVPREV }
						}
					}
					owner = {
						set_character_flag = prev_prince
					}
				}
				destroy_landed_title = THIS
			}
			any_demesne_title = {
				limit = {
					tier = king
					or = {
						is_landless_type_title = no
						temporary = yes
					}
				}
				if = {
					limit = {
						has_global_flag = emf_nwo_king
						has_global_flag = emf_nwo_retain_rulers
						owner = {
							capital_holding = { de_jure_liege_or_above = PREVPREV }
						}
					}
					owner = {
						set_character_flag = prev_prince
					}
				}
				destroy_landed_title = THIS
			}
			any_demesne_title = {
				limit = {
					tier = emperor
					or = {
						is_landless_type_title = no
						temporary = yes
					}
				}
				destroy_landed_title = THIS
			}
		}
		
		# Now that de jure duke-tier or higher titles are destroyed, make any any de jure title
		# structure changes to the map appropriate for NWO (since the old titles will not be
		# held any longer, if they need to be deactivated).
		character_event = { id = emf_nwo.40 } # Adjustments common to both SWMH and vanilla
		character_event = { id = emf_nwo.41 } # Map-specific adjustments (SWMH and vanilla versions of emf_nwo_map.txt contain this event)
		
		# The duke-tier or higher rulers are going to be a problem. We need them to give up all their
		# land and return to floating around in CKII outer space as independents without earthly
		# connections.
		
		any_playable_ruler = {
			limit = {
				higher_tier_than = count
				is_landed = yes
				primary_title = { is_landless_type_title = yes }
				or = {
					top_liege = { religion = catholic }
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					top_liege = { religion_group = christian }
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					top_liege = { religion_group = muslim }
					not = { has_global_flag = emf_nwo_only_muslim }
				}
				or = {
					not = { has_landed_title = k_papal_state }
					not = {
						has_global_flag = emf_nwo_spare_pope
						has_global_flag = emf_nwo_spare_pope_only
					}
				}
				or = {
					and = {
						is_merchant_republic = no
						not = { any_liege = { is_merchant_republic = yes } }
					}
					not = { has_global_flag = emf_nwo_spare_mr }
				}
			}
			
			# Grant away all your count titles to new characters.
			character_event = { id = emf_nwo.30 }
			
			# And all your barony titles to appropriate characters (owner of their county).
			any_demesne_title = {
				limit = { tier = baron }
				dejure_liege_title = {
					owner = {
						grant_title_no_opinion = PREVPREV
					}
				}
			}
			
			# If your landless title was binding any vassals, they'll be freed in next step.
		}
		
		any_playable_ruler = {
			limit = {
				independent = no
				or = {
					top_liege = { religion = catholic }
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					top_liege = { religion_group = christian }
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					top_liege = { religion_group = muslim }
					not = { has_global_flag = emf_nwo_only_muslim }
				}
				or = {
					not = { k_papal_state = { owner = { is_vassal_or_below = PREVPREV } } }
					not = { has_global_flag = emf_nwo_spare_pope }
				}
				or = {
					not = { any_liege = { is_merchant_republic = yes } }
					not = { has_global_flag = emf_nwo_spare_mr }
				}
			}
			set_defacto_liege = THIS
		}
		
		# Now, there are only count-tier playable rulers (besides anybody excluded by customization
		# options). If nwo_spare_mr, merchant republics are all independent, and if nwo_spare_pope,
		# the Papacy is independent, and if nwo_spare_pope_only, the Papacy is independent but only
		# has 1 county personally held by the Pope and no vassals. Currently, just selecting all
		# count-tier independent rulers would be a shortcut for addressing those rulers affected
		# by New World Order.
		
		# These count-tier rulers should be reduced to their capital county, either by finding a
		# vassal baron to grant an excess county, granting to a courtier, or by generating a new
		# character to hold it. In general, all playable rulers in the New World Order "zone"
		# will have only 1 demesne county.
		
		any_independent_ruler = {
			limit = {
				tier = count
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			character_event = { id = emf_nwo.31 } # Grant excess counties to barons w/i counties (iterative)
			character_event = { id = emf_nwo.32 } # Grant excess counties to unrelated, non-councillor courtiers (iterative)
			character_event = { id = emf_nwo.33 } # Grant excess counties to new, random characters (recursive)
			
			
			# Seize any non-de-jure baronies.
			character_event = { id = emf_nwo.21 }
		}
		
		# Now, a couple definitions:
		#   principality - a de jure title of tier determined by nwo_count/nwo_duke/nwo_king setting
		#   prince - character selected to rule a principality. they will be independent when done.
		#   princelings - any of the characters who could have been selected to be a prince.
		
		# Each princeling's principality is determined by their capital's location. When selecting a
		# prince, we require that the principality have no holder (or else it belongs to an excluded
		# realm). Thus, not every princeling will get a chance to be a prince. Those that don't will
		# still be treated as princes of their count-tier capital principality.
		
		# FOR DUKE-TIER AND KING-TIER PRINCIPALITIES:
		
		# For principality tiers greater than count-level, prince selection within the principality follows
		# this preference rule:
		#   ai = no
		#   feudal
		#   tribal
		#   republic
		#   *
		
		# If the option emf_nwo_retain_rulers is selected, we prefer the previous ruler of a given
		# principality if he exists (with preference still given to players unless they specifically
		# select otherwise).
		
		# Otherwise, prince selection is completely random. [ An alternate strategy would be
		# to pick princes that are most likely to succeed, but that's really not even
		# necessarily desired for New World Order. ]
		
		# Due to SWMH's lack of de jure empires in places, the 'Remove Ahistorical Empires' customization,
		# and generally the possibility of dynamic de jure kingdom titles on the map, we cannot work
		# through the principalities top-down through a list of de jure empire titles or even kingdom
		# titles.

		# Instead, we recurse over all princelings, selecting those that have an unheld principality, in the
		# order of our prince selection rules, and we make those random selections princes by granting them
		# the principality and transferring de jure princeling vassals to them.
		
		if = {
			limit = { has_global_flag = emf_nwo_duke }
			if = {
				limit = {
					has_global_flag = emf_nwo_retain_rulers
					not = { has_global_flag = emf_nwo_retain_rulers_not_me }
				}
				character_event = { id = emf_nwo.55 } # Select previous princes (duke) [recursive]
			}
			character_event = { id = emf_nwo.50 } # Select ai = no princes (duke) [recursive]
			if = {
				limit = { has_global_flag = emf_nwo_retain_rulers_not_me }
				character_event = { id = emf_nwo.55 } # Select previous princes (duke) [recursive]
			}
			character_event = { id = emf_nwo.51 } # Select feudal princes (duke) [recursive]
			character_event = { id = emf_nwo.52 } # Select tribal princes (duke) [recursive]
			character_event = { id = emf_nwo.53 } # Select republic princes (duke) [recursive]
			character_event = { id = emf_nwo.54 } # Select any princes (duke) [recursive]
		}
		
		if = {
			limit = { has_global_flag = emf_nwo_king }
			if = {
				limit = {
					has_global_flag = emf_nwo_retain_rulers
					not = { has_global_flag = emf_nwo_retain_rulers_not_me }
				}
				character_event = { id = emf_nwo.65 } # Select previous princes (king) [recursive]
			}
			character_event = { id = emf_nwo.60 } # Select ai = no princes (king) [recursive]
			if = {
				limit = { has_global_flag = emf_nwo_retain_rulers_not_me }
				character_event = { id = emf_nwo.65 } # Select previous princes (king) [recursive]
			}
			character_event = { id = emf_nwo.60 } # Select ai = no princes (king) [recursive]
			character_event = { id = emf_nwo.61 } # Select feudal princes (king) [recursive]
			character_event = { id = emf_nwo.62 } # Select tribal princes (king) [recursive]
			character_event = { id = emf_nwo.63 } # Select republic princes (king) [recursive]
			character_event = { id = emf_nwo.64 } # Select any princes (king) [recursive]
		}
		
		# Cleanup option global flags (this allows the player to re-invoke the customization decision if
		# they want to change options)
		clr_global_flag = emf_nwo_count
		clr_global_flag = emf_nwo_duke
		clr_global_flag = emf_nwo_king
		clr_global_flag = emf_nwo_only_catholic
		clr_global_flag = emf_nwo_only_christian
		clr_global_flag = emf_nwo_only_muslim
		clr_global_flag = emf_nwo_retain_rulers
		clr_global_flag = emf_nwo_retain_rulers_not_me
		clr_global_flag = emf_nwo_spare_mr
		clr_global_flag = emf_nwo_spare_pope
		clr_global_flag = emf_nwo_spare_pope_only
	}
}


# emf_nwo.21 [Princeling]
#
# Seize/vassalize any non-de-jure baronies.
character_event = {
	id = emf_nwo.21
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK

		capital_scope = {
			county = {
				# First, try to vassalize non-de-jure barons
				any_direct_de_jure_vassal_title = {
					limit = {
						owner = {
							not = {
								character = ROOT
								vassal_of = ROOT
							}
							tier = baron
							not = {
								any_demesne_title = {
									not = {
										de_jure_liege = PREVPREVPREV # County
									}
								}
							}
						}
					}
					owner = {
						set_defacto_liege = ROOT
					}
				}
				# Then seize the rest
				any_direct_de_jure_vassal_title = {
					limit = {
						owner = {
							not = {
								character = ROOT
								vassal_of = ROOT
							}
						}
					}
					grant_title_no_opinion = ROOT
				}
			}
		}
	}
}


# emf_nwo.22 [Prince]
#
# Vassalize the de jure vassal princelings of my principality.
character_event = {
	id = emf_nwo.22
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		
		primary_title = {
			any_de_jure_vassal = {
				limit = {
					tier = count
					independent = yes
					or = {
						religion = catholic
						not = { has_global_flag = emf_nwo_only_catholic }
					}
					or = {
						religion_group = christian
						not = { has_global_flag = emf_nwo_only_christian }
					}
					or = {
						religion_group = muslim
						not = { has_global_flag = emf_nwo_only_muslim }
					}
				}
				set_defacto_liege = ROOT
			}
		}
		
		if = {
			limit = { tier = king }
			
			# Give three free random duchies to the prince-king in order
			# to prevent insurmountable vassal limit issues in very large
			# kingdoms.
			
			wealth = 500
		}
	}
}


# emf_nwo.23 [Playable Ruler]
#
# Cleanup state from prior era.
character_event = {
	id = emf_nwo.23
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		
		# End wars from the prior era
		any_war = {
			limit = {
				or = {
					any_attacker = { character = ROOT }
					any_defender = { character = ROOT }
				}
			}
			end_war = invalid
		}
			
		# Disband any event troops (all spawns have been overridden in character history to
		# be marked with the earmark start_troops if they weren't earmarked)
		disband_event_forces = start_troops
		disband_event_forces = norman_byzantine_war
		disband_event_forces = williams_invasion_fleet
		disband_event_forces = norwegian_invasion
		disband_event_forces = saxon_defense_force
			
		# Remove now-irrelevant personal claims they may have (we're changing history here)
		any_claim = {
			remove_claim = PREV
		}
		any_courtier = {
			any_claim = {
				remove_claim = PREV
			}
		}
	}
}


# emf_nwo.30 [Ruler of a landless title that's also landed]
#
# Tail-recursive event which grants away all count titles to new characters.
character_event = {
	id = emf_nwo.30
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		any_demesne_title = {
			is_landless_type_title = yes
		}
		num_of_count_titles = 1
	}
	
	option = {
		name = OK
		
		random_demesne_title = {
			limit = {
				tier = count
			}
			location = {
				ROOT = {
					create_character = {
						random_traits = yes
						religion = PREV # Province
						culture = PREV # Province
						dynasty = random
						female = no
					}
					new_character = {
						grant_title_no_opinion = PREVPREVPREV # County
						set_defacto_liege = THIS
					}
				}
			}
		}
		
		character_event = { id = emf_nwo.30 }
	}
}


# emf_nwo.31 [COUNT+ Ruler]
#
# Grant excess demesne counties to existing province barons.
character_event = {
	id = emf_nwo.31
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		num_of_count_titles = 2
	}
	
	option = {
		name = OK
		
		capital_scope = {
			county = {
				ROOT = {
					any_demesne_title = {
						limit = {
							tier = count
							not = { title = PREVPREV } # Not capital county
							ROOT = {
								any_vassal = {
									tier = baron
									any_demesne_title = {
										de_jure_liege = PREVPREVPREV # County
									}
								}
							}
						}
						ROOT = {
							random_vassal = {
								limit = {
									tier = baron
									any_demesne_title = {
										de_jure_liege = PREVPREVPREV # County
									}
								}
								
								# Take away their baronies in county temporarily
								# so that they don't automatically switch their
								# previous barony to the county capital (as, 99%
								# of the time, it wasn't feudal)
								any_demesne_title = {
									limit = { de_jure_liege = PREVPREVPREV } # County
									grant_title_no_opinion = ROOT
								}
								
								# Give them the county
								grant_title_no_opinion = PREVPREV
								
								# Ensure their character type switches to that of the
								# province capital barony
								capital = PREVPREV
								
								# Give them any of our baronies within the county,
								# including at least one that we took from them temporarily
								ROOT = {
									any_demesne_title = {
										limit = {
											tier = baron
											de_jure_liege = PREVPREVPREVPREV # County
										}
										grant_title = PREVPREV # New ruler
									}
								}
								
								# Make sure they're independent
								set_defacto_liege = THIS
							}
						}
					}
				}
			}
		}
	}
}


# emf_nwo.32 [COUNT+ Ruler]
#
# Grant excess demesne counties to courtiers.
character_event = {
	id = emf_nwo.32
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		num_of_count_titles = 2
	}
	
	option = {
		name = OK
		
		capital_scope = {
			county = {
				ROOT = {
					any_demesne_title = {
						limit = {
							tier = count
							not = { title = PREVPREV } # Not capital county
							ROOT = {
								any_courtier = {
									prisoner = no
									is_female = no
									is_adult = yes
									not = { dynasty = ROOT }
									not = { any_spouse = { character = ROOT } }
									not = { is_child_of = ROOT }
									not = { is_councillor = yes }
									or = {
										diplomacy = 7
										martial = 7
										stewardship = 7
										intrigue = 7
										learning = 7
									}
									num_of_children = 1
								}
							}
						}
						ROOT = {
							random_courtier = {
								limit = {
									prisoner = no
									is_female = no
									is_adult = yes
									not = { dynasty = ROOT }
									not = { any_spouse = { character = ROOT } }
									not = { is_child_of = ROOT }
									not = { is_councillor = yes }
									or = {
										diplomacy = 7
										martial = 7
										stewardship = 7
										intrigue = 7
										learning = 7
									}
									num_of_children = 1
								}
								grant_title = PREVPREV # County
								set_defacto_liege = THIS
							}
						}
					}
					any_demesne_title = {
						limit = {
							tier = count
							not = { title = PREVPREV } # Not capital county
							ROOT = {
								any_courtier = {
									prisoner = no
									is_female = no
									is_adult = yes
									not = { dynasty = ROOT }
									not = { any_spouse = { character = ROOT } }
									not = { is_child_of = ROOT }
									not = { is_councillor = yes }
									or = {
										diplomacy = 7
										martial = 7
										stewardship = 7
										intrigue = 7
										learning = 7
									}
								}
							}
						}
						ROOT = {
							random_courtier = {
								limit = {
									prisoner = no
									is_female = no
									is_adult = yes
									not = { dynasty = ROOT }
									not = { any_spouse = { character = ROOT } }
									not = { is_child_of = ROOT }
									not = { is_councillor = yes }
									or = {
										diplomacy = 7
										martial = 7
										stewardship = 7
										intrigue = 7
										learning = 7
									}
								}
								grant_title = PREVPREV # County
								set_defacto_liege = THIS
							}
						}
					}
				}
			}
		}
	}
}

# emf_nwo.33 [COUNT+ Ruler]
#
# Grant excess demesne counties to new characters. [Recursive]
character_event = {
	id = emf_nwo.33
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		num_of_count_titles = 2
	}
	
	option = {
		name = OK
		
		capital_scope = {
			county = {
				ROOT = {
					random_demesne_title = {
						limit = {
							tier = count
							not = { title = PREVPREV }
						}
						location = {
							ROOT = {
								# Vary the age (but keep them young) and try to make the
								# game less of a sausage fest by creating male and female
								# rulers at a ratio of 2:1. Give them fixed base health and
								# fertility of 50%. We don't want them dying w/o heirs.
								random_list = {
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 16
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 16
										}
									}
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 17
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 17
										}
									}
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 20
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 19
										}
									}
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 21
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 21
										}
									}
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 22
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 22
										}
									}
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 25
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 24
										}
									}
									10 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = no
											age = 27
										}
									}
									5 = {
										create_character = {
											random_traits = yes
											religion = PREV # Province
											culture = PREV # Province
											dynasty = random
											health = 0.5
											fertility = 0.5
											female = yes
											age = 26
										}
									}
								}
								new_character = {
									grant_title = PREVPREVPREV
									set_defacto_liege = THIS
								}
							}
						}
					}
				}
			}
		}
		
		character_event = { id = emf_nwo.33 }
	}
}



# emf_nwo.40 [Isis]
#
# Adjust the de jure title structure of the map to be better-suited for
# New World Order. [Common adjustments]
character_event = {
	id = emf_nwo.40
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		
	}
}


# emf_nwo.41 is map-specific and lives in emf_nwo_map.txt


# emf_nwo.50 [Isis]
#
# Select prince (ai = no) for duchy principality. [Recursive]
character_event = {
	id = emf_nwo.50
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			ai = no
			tier = count
			capital_scope = { duchy = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				ai = no
				tier = count
				capital_scope = { duchy = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				duchy = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.50 }
	}
}


# emf_nwo.51 [Isis]
#
# Select prince (is_feudal = yes) for duchy principality. [Recursive]
character_event = {
	id = emf_nwo.51
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			is_feudal = yes
			tier = count
			capital_scope = { duchy = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				is_feudal = yes
				tier = count
				capital_scope = { duchy = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				duchy = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.51 }
	}
}


# emf_nwo.52 [Isis]
#
# Select prince (is_tribal = yes) for duchy principality. [Recursive]
character_event = {
	id = emf_nwo.52
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			is_tribal = yes
			tier = count
			capital_scope = { duchy = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				is_tribal = yes
				tier = count
				capital_scope = { duchy = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				duchy = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.52 }
	}
}


# emf_nwo.53 [Isis]
#
# Select prince (is_republic = yes) for duchy principality. [Recursive]
character_event = {
	id = emf_nwo.53
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			is_republic = yes
			tier = count
			capital_scope = { duchy = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				is_republic = yes
				tier = count
				capital_scope = { duchy = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				duchy = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.53 }
	}
}


# emf_nwo.54 [Isis]
#
# Select prince (any) for duchy principality. [Recursive]
character_event = {
	id = emf_nwo.54
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			tier = count
			capital_scope = { duchy = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				tier = count
				capital_scope = { duchy = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				duchy = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.54 }
	}
}


# emf_nwo.55 [Isis]
#
# Select previous prince for duchy principality. [Recursive]
character_event = {
	id = emf_nwo.55
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			tier = count
			capital_scope = { duchy = { has_holder = no } }
			has_character_flag = prev_prince
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				tier = count
				capital_scope = { duchy = { has_holder = no } }
				has_character_flag = prev_prince
			}
			capital_scope = {
				duchy = {
					grant_title = PREVPREV
				}
			}
			clr_character_flag = prev_prince
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.55 }
	}
}


# emf_nwo.60 [Isis]
#
# Select prince (ai = no) for kingdom principality. [Recursive]
character_event = {
	id = emf_nwo.60
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			ai = no
			tier = count
			capital_scope = { kingdom = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				ai = no
				tier = count
				capital_scope = { kingdom = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				kingdom = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.60 }
	}
}


# emf_nwo.61 [Isis]
#
# Select prince (is_feudal = yes) for kingdom principality. [Recursive]
character_event = {
	id = emf_nwo.61
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			is_feudal = yes
			tier = count
			capital_scope = { kingdom = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				is_feudal = yes
				tier = count
				capital_scope = { kingdom = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				kingdom = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.61 }
	}
}


# emf_nwo.62 [Isis]
#
# Select prince (is_tribal = yes) for kingdom principality. [Recursive]
character_event = {
	id = emf_nwo.62
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			is_tribal = yes
			tier = count
			capital_scope = { kingdom = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				is_tribal = yes
				tier = count
				capital_scope = { kingdom = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				kingdom = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.62 }
	}
}


# emf_nwo.63 [Isis]
#
# Select prince (is_republic = yes) for kingdom principality. [Recursive]
character_event = {
	id = emf_nwo.63
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			is_republic = yes
			tier = count
			capital_scope = { kingdom = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				is_republic = yes
				tier = count
				capital_scope = { kingdom = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				kingdom = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.63 }
	}
}


# emf_nwo.64 [Isis]
#
# Select prince (any) for kingdom principality. [Recursive]
character_event = {
	id = emf_nwo.64
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			tier = count
			capital_scope = { kingdom = { has_holder = no } }
			or = {
				religion = catholic
				not = { has_global_flag = emf_nwo_only_catholic }
			}
			or = {
				religion_group = christian
				not = { has_global_flag = emf_nwo_only_christian }
			}
			or = {
				religion_group = muslim
				not = { has_global_flag = emf_nwo_only_muslim }
			}
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				tier = count
				capital_scope = { kingdom = { has_holder = no } }
				or = {
					religion = catholic
					not = { has_global_flag = emf_nwo_only_catholic }
				}
				or = {
					religion_group = christian
					not = { has_global_flag = emf_nwo_only_christian }
				}
				or = {
					religion_group = muslim
					not = { has_global_flag = emf_nwo_only_muslim }
				}
			}
			capital_scope = {
				kingdom = {
					grant_title = PREVPREV
				}
			}
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.64 }
	}
}


# emf_nwo.65 [Isis]
#
# Select previous prince for kingdom principality. [Recursive]
character_event = {
	id = emf_nwo.65
	desc = AI_EVENT
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_independent_ruler = {
			tier = count
			capital_scope = { kingdom = { has_holder = no } }
			has_character_flag = prev_prince
		}
	}
	
	option = {
		name = OK
		
		random_independent_ruler = {
			limit = {
				tier = count
				capital_scope = { kingdom = { has_holder = no } }
				has_character_flag = prev_prince
			}
			capital_scope = {
				kingdom = {
					grant_title = PREVPREV
				}
			}
			clr_character_flag = prev_prince
			character_event = { id = emf_nwo.22 }
		}
		
		character_event = { id = emf_nwo.65 }
	}
}
