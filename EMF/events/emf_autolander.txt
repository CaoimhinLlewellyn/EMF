namespace = emf_autolander
	
# TODO:
# - Support gender_equality and succ_enatic_cognatic and succ_enatic: pick females too
#   when appropriate.
# - Support automatic distribution of recently-built titles baron-tier titles that cannot
#   be legally held by the liege (e.g., if you build a couple new cities in your demesne
#   and aren't a patrician, then autolander should be able to automate grants of those
#   titles with characters specifically suited for the holding_type (e.g., priests holding
#   new temples for non-muslims).
# - Potentially support the option of converting a feudal county into a republican county
#   or vice versa if both a castle and a city are newly-acquired within the county. Could
#   do the same for promoting prince-bishropics or feudalizing them. It would simply be a
#   matter of being sure to grant the new noble the proper type of holding first, then making
#   that holding the province_capital.


# emf_autolander.1
# Title transfer listener for applying Recently Acquired
#
# Taps: on_new_holder (grants + territory gained through gain_all_occupied_titles, gain_title, etc.)
#       on_new_holder_usurpation (general usurpation)
#       on_new_holder_inheritance (inheritance)
#
character_event = {
	id = emf_autolander.1
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	ai = no
	
	trigger = {
		FROM = {
			tier = count
		}
	}
	
	immediate = {
		FROM = {
			location = {
				remove_province_modifier = emf_mod_recently_acquired
				add_province_modifier = { name = emf_mod_recently_acquired duration = 120 }
			}
		}
	}
	
	option = { name = OK }
}


# emf_autolander.2 [Player]
#
# Recursive event for non-interactive land distribution (multiplayer)
character_event = {
	id = emf_autolander.2
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_demesne_title = {
			tier = count
			location = {
				has_province_modifier = emf_mod_recently_acquired
			}
			not = {
				ROOT = {
					capital_scope = {
						duchy = {
							de_jure_vassal_or_below = PREVPREVPREV
						}
					}
				}
			}
			can_be_given_away = yes
		}
	}
	
	option = {
		name = OK
		
		random_demesne_title = {
			limit = {
				tier = count
				location = {
					has_province_modifier = emf_mod_recently_acquired
				}
				not = {
					ROOT = {
						capital_scope = {
							duchy = {
								de_jure_vassal_or_below = PREVPREVPREV
							}
						}
					}
				}
				can_be_given_away = yes
			}

			save_event_target_as = target_county

			create_random_steward = {
				random_traits = yes
				religion = ROOT
				culture = ROOT
				dynasty = random
				female = no
				fertility = 0.5
				health = 5
			}
			new_character = {
				hidden_tooltip = {
					if = {
						limit = {
							religion_group = indian_group
						}
						add_trait = kshatriya
						character_event = { id = RoI.30121 }
					}
					
					character_event = { id = emf_autolander.10 } # Grant target_county
				}
			}
			
			clear_event_target = target_county
		}
		
		character_event = { id = emf_autolander.2 } # Tail-recurse
	}
}

# emf_autolander.2 [Player]
#
# County selection (only for interactive/singleplayer mode)
# Reentrant
character_event = {
	id = emf_autolander.3
	hide_window = yes
	is_triggered_only = yes
	
	option = {
		name = OK
		
		if = {
			limit = {
				not = {
					any_demesne_title = {
						tier = count
						not = { has_title_flag = emf_autolander_spare }
						location = {
							has_province_modifier = emf_mod_recently_acquired
						}
						not = {
							ROOT = {
								capital_scope = {
									duchy = {
										de_jure_vassal_or_below = PREVPREVPREV
									}
								}
							}
						}
						can_be_given_away = yes
					}
				}
			}
			
			# Cleanup. We're done prompting for this round.
			any_demesne_title = {
				limit = { tier = count }
				clr_title_flag = emf_autolander_spare
			}
			
			break = yes
		}
		
		random_demesne_title = {
			limit = {
				tier = count
				not = { has_title_flag = emf_autolander_spare }
				location = {
					has_province_modifier = emf_mod_recently_acquired
				}
				not = {
					ROOT = {
						capital_scope = {
							duchy = {
								de_jure_vassal_or_below = PREVPREVPREV
							}
						}
					}
				}
				can_be_given_away = yes
			}
			
			if = {
				limit = {
					num_fitting_characters_for_title = 1
					not = { num_fitting_characters_for_title = 2 }
				}
				best_fit_character_for_title = {
					title = PREV 			# The Title we are looking at
					perspective = ROOT		# From whose perspective we are viewing the title
					index = 1 				# The index of the character in the list
					save_event_target_as = char_one
				}
			}
			if = {
				limit = {
					num_fitting_characters_for_title = 2
				}
				best_fit_character_for_title = {
					title = PREV 			# The Title we are looking at
					perspective = ROOT		# From whose perspective we are viewing the title
					index = 1 				# The index of the character in the list
					save_event_target_as = char_one
				}
				best_fit_character_for_title = {
					title = PREV 			# The Title we are looking at
					perspective = ROOT		# From whose perspective we are viewing the title
					index = 2 				# The index of the character in the list
					save_event_target_as = char_two
				}
			}
			
			save_event_target_as = target_county
		}

			
		if = {
			limit = { event_target:char_one = { is_alive = yes } }
			event_target:char_one = {
				character_event = { id = emf_autolander.4 } # Bounce them into proper FROM and FROMFROM scopes of prompt event
			}
		}
		if = {
			limit = { not = { event_target:char_one = { is_alive = yes } } }
			character_event = { id = emf_autolander.4 } # The show must go on
		}
	}
}


character_event = {
	id = emf_autolander.4
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		clear_event_target = char_one
		if = {
			limit = { event_target:char_two = { is_alive = yes } }
			event_target:char_two = {
				character_event = { id = emf_autolander.5 } # Bounce them into proper FROM and FROMFROM scopes of prompt event
			}
		}
		if = {
			limit = { not = { event_target:char_two = { is_alive = yes } } }
			FROM = { character_event = { id = emf_autolander.5 } } # The show must go on
		}
	}
}


character_event = {
	id = emf_autolander.5
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		clear_event_target = char_two
		FROMFROM = { character_event = { id = emf_autolander.6 } } # And on to the prompt
	}
}


# emf_autolander.6 [Player]
#
# Main province prompt event
character_event = {
	id = emf_autolander.6
	desc = emf_autolander.6.desc
	picture = GFX_evt_small_town
	is_triggered_only = yes

	option = {
		name = emf_autolander.6.opt.a
		
		create_random_steward = {
			random_traits = yes
			religion = ROOT
			culture = ROOT
			dynasty = random
			female = no
			fertility = 0.5
			health = 5
		}
		new_character = {
			hidden_tooltip = {
				if = {
					limit = {
						religion_group = indian_group
					}
					add_trait = kshatriya
					character_event = { id = RoI.30121 }
				}
				
				character_event = { id = emf_autolander.10 } # Grant target_county
			}
		}
		
		hidden_tooltip = {
			character_event = { id = emf_autolander.3 }
		}
	}
	
	option = {
		name = emf_autolander.6.opt.b
		trigger = {
			FROMFROM = {
				is_alive = yes
				prisoner = no
				not = { character = ROOT }
			}
			
			# Avoid accidentally putting the gavelkind primary heir within easy clicking range (can go badly)
			primary_title = {
				or = {
					not = {
						has_law = succ_gavelkind
						has_law = succ_elective_gavelkind
					}
					current_heir = {
						not = { character = FROMFROM }
					}
				}
			}
		}
		
		FROMFROM = {
			if = {
				limit = {
					or = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = no
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_family_fromfrom
				}
			}
			if = {
				limit = {
					not = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = yes
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_councillor
				}
			}
			if = {
				limit = {
					or = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = yes
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_family_councillor_fromfrom
				}
			}
			if = {
				limit = {
					not = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = no
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_other
				}
			}
			hidden_tooltip = {
				character_event = { id = emf_autolander.10 } # Grant target_county
			}
		}
		
		hidden_tooltip = {
			character_event = { id = emf_autolander.3 }
		}
	}
	
	option = {
		name = emf_autolander.6.opt.c
		trigger = {
			FROM = {
				is_alive = yes
				prisoner = no
				not = {
					character = ROOT
					character = FROMFROM # Weird case... (both index = 1 and index = 2 best_fit_character_for_title were same)
				}
			}
			
			# Avoid accidentally putting the gavelkind primary heir within easy clicking range (can go badly)
			primary_title = {
				or = {
					not = {
						has_law = succ_gavelkind
						has_law = succ_elective_gavelkind
					}
					current_heir = {
						not = { character = FROM }
					}
				}
			}
		}
		
		FROM = {
			if = {
				limit = {
					or = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = no
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_family_from
				}
			}
			if = {
				limit = {
					not = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = yes
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_councillor
				}
			}
			if = {
				limit = {
					or = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = yes
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_family_councillor_from
				}
			}
			if = {
				limit = {
					not = {
						is_close_relative = ROOT
						dynasty = ROOT
					}
					is_councillor = no
				}
				custom_tooltip = {
					text = emf_autolander_ctt_grant_other
				}
			}
			hidden_tooltip = {
				character_event = { id = emf_autolander.10 } # Grant target_county
			}
		}
		
		hidden_tooltip = {
			character_event = { id = emf_autolander.3 }
		}
	}
	
	option = {
		name = emf_autolander.6.opt.d
		
		hidden_tooltip = {
			# NOTE: Not removing the emf_mod_recently_acquired in this case to enable multiple runs,
			# but to avoid an infinite loop of prompts (continually asking about the same provinces
			# rather than exiting), we flag the county title. A second run will clear all such flags
			# first, although with the current design, we will leave some flags lingering if there
			# is no second run (no big deal).
			
			event_target:target_county = {
				set_title_flag = emf_autolander_spare
			}

			clear_event_target = target_county
			character_event = { id = emf_autolander.3 }
		}
	}
}


# emf_autolander.10 [Grantee]
#
# FROM grants event_target:target_county and any minor holdings in it to ROOT
character_event = {
	id = emf_autolander.10
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		event_target:target_county = {
			FROM = {
				# Grant the capital barony if it matches our character type
				random_demesne_title = {
					limit = {
						tier = baron
						de_jure_liege = event_target:target_county
						is_capital = yes
						or = {
							and = {
								FROM = { is_republic = yes }
								is_republic = yes
							}
							and = {
								FROM = { is_feudal = yes }
								is_feudal = yes
							}
						}
					}
					grant_title = ROOT
				}
				
				# Grant any minor holdings that match our character type
				any_demesne_title = {
					limit = {
						tier = baron
						de_jure_liege = event_target:target_county
						or = {
							and = {
								FROM = { is_republic = yes }
								is_republic = yes
							}
							and = {
								FROM = { is_feudal = yes }
								is_feudal = yes
							}
						}
					}
					grant_title = ROOT
				}
			}
			
			# Grant the county
			grant_title = ROOT
			
			# Grant any remaining minor holdings
			FROM = {
				any_demesne_title = {
					limit = {
						tier = baron
						de_jure_liege = event_target:target_county
					}
					grant_title = ROOT
				}
			}
					
			location = {
				remove_province_modifier = emf_mod_recently_acquired
			}
		}
		
		clear_event_target = target_county
	}
}
