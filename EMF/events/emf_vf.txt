
namespace = emf_vf

# emf_vf.0
# Proxy event for sending faction_vf_legalize_cooperation ultimatum
#
# ROOT = faction leader
character_event = {
	id = emf_vf.0
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		in_faction = faction_vf_legalize_cooperation
	}
	
	immediate = {
		# Give the faction diplomatic immunity (when do they lose immunity? when war is declared?)
		diplomatic_immunity = yes
		any_faction_backer = {
			faction = faction_vf_legalize_cooperation
			diplomatic_immunity = yes
		}
	}

	# AI LIEGE OPTIONS
	##################
	
	option = { # AI liege folds to the ultimatum
		name = OK

		trigger = {
			liege = { ai = yes }
		}

		ai_chance = {
			factor = 20
			
			modifier = {
				factor = 0
				not = {
					faction_power = {
						faction = faction_vf_legalize_cooperation
						power = 0.5
					}
				}
			}
			modifier = {
				factor = 1.25
				liege = { trait = craven }
			}
			modifier = {
				factor = 1.25
				liege = { trait = humble }
			}
			modifier = {
				factor = 1.25
				liege = { trait = kind }
			}
			modifier = {
				factor = 1.25
				liege = { trait = charitable }
			}
			modifier = {
				factor = 1.25
				liege = { trait = patient }
			}
			modifier = {
				factor = 1.25
				liege = { trait = content }
			}
			modifier = {
				factor = 1.5
				liege = { trait = just }
			}
			modifier = {
				factor = 1.5
				liege = { trait = liberal }
			}
			modifier = {
				factor = 1.5
				liege = { trait = trusting }
			}
		}

		character_event = { id = emf_vf.10 }
	}
	option = { # AI liege denies the ultimatum
		name = OK

		trigger = {
			liege = { ai = yes }
		}

		ai_chance = {
			factor = 80

			modifier = {
				factor = 1.25
				liege = { trait = proud }
			}
			modifier = {
				factor = 1.5
				liege = { trait = arbitrary }
			}
			modifier = {
				factor = 1.25
				liege = { trait = wroth }
			}
			modifier = {
				factor = 1.25
				liege = { trait = conservative }
			}
			modifier = {
				factor = 1.5
				liege = { trait = paranoid }
			}
			modifier = {
				factor = 1.25
				liege = { trait = cruel }
			}
			modifier = {
				factor = 0.5
				faction_power = {
					faction = faction_vf_legalize_cooperation
					power = 1.0
				}
			}
			modifier = {
				factor = 0.667
				faction_power = {
					faction = faction_vf_legalize_cooperation
					power = 1.5
				}
			}
			modifier = {
				factor = 0.5
				faction_power = {
					faction = faction_vf_legalize_cooperation
					power = 2.0
				}
			}
			modifier = {
				factor = 0.5
				faction_power = {
					faction = faction_vf_legalize_cooperation
					power = 3.0
				}
			}	
			modifier = {
				factor = 0.5
				faction_power = {
					faction = faction_vf_legalize_cooperation
					power = 4.0
				}
			}
		}

		character_event = { id = emf_vf.11 }
	}
	
	# PLAYER LIEGE VARIANTS
	#######################

	option = {
		name = OK # Liege is player, send ultimatum variant: Let family not be foes.

		trigger = {
			liege = { ai = no }
			liege = {
				or = {
					is_close_relative = root
					is_allied_with = root
					dynasty = root
				}
			}
		}

		ai_chance = {
			factor = 20
		}

		liege = { letter_event = { id = emf_vf.1 } }
	}
	option = {
		name = OK # Liege is player, send ultimatum variant: I think very highly of you, and that's why I know you'll do the right thing.

		trigger = {
			liege = { ai = no }
			opinion = { who = liege value = 30 }
		}
		
		ai_chance = {
			factor = 10
			
			modifier = {
				factor = 1.1
				opinion = { who = liege value = 40 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = liege value = 50 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = liege value = 60 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = liege value = 70 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = liege value = 80 }
			}
			modifier = {
				factor = 1.1
				opinion = { who = liege value = 90 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = liege value = 100 }
			}
		}

		liege = { letter_event = { id = emf_vf.2 } }
	}
	option = {
		name = OK # Liege is player, send ultimatum variant: Neutral: Permit us to cooperate autonomously as is our right, or we will resort to force.

		trigger = {
			liege = { ai = no }
		}

		ai_chance = {
			factor = 10
		}
		
		liege = { letter_event = { id = emf_vf.3 } }
	}
	option = {
		name = OK # Liege is player, send ultimatum variant: Negative: Liege is disliked by faction leader.

		trigger = {
			liege = { ai = no }
			not = { opinion = { who = liege value = 0 } }
		}

		ai_chance = {
			factor = 10
			
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -10 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -20 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -30 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -40 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -60 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -70 } }
			}
		}
		
		liege = { letter_event = { id = emf_vf.4 } }
	}
	option = {
		name = OK # Liege is player, send ultimatum variant: Negative: Liege is hated by faction leader.
		
		trigger = {
			liege = { ai = no }
			not = { opinion = { who = liege value = -30 } }
		}
		
		ai_chance = {
			factor = 10
			
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -40 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -50 } }
			}
			modifier = {
				factor = 1.1
				not = { opinion = { who = liege value = -60 } }
			}
			modifier = {
				factor = 1.15
				not = { opinion = { who = liege value = -70 } }
			}
			modifier = {
				factor = 1.2
				not = { opinion = { who = liege value = -80 } }
			}
			modifier = {
				factor = 1.3
				not = { opinion = { who = liege value = -90 } }
			}
			modifier = {
				factor = 1.5
				not = { opinion = { who = liege value = -100 } }
			}
		}
		
		liege = { letter_event = { id = emf_vf.5 } }
	}
}


# emf_vf.1
# Ultimatum letter from FROM, the faction leader, sent to ROOT, the liege (ai = no)
# Variant: Positive: Let family not be foes.
letter_event = {
	id   = emf_vf.1
	desc = emf_vf.1.desc
	is_triggered_only = yes
	
	option = {
		name = emf_vf.1.opt.a
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_fold
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.10 } }
			}
		}
	}
	
	option = {
		name = emf_vf.1.opt.b
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_deny
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.11 } }
			}
		}
	}
}


# emf_vf.2
# Ultimatum letter from FROM, the faction leader, sent to ROOT, the liege (ai = no)
# Variant: Positive: I think very highly of you, and that's why I know you'll do the right thing.
letter_event = {
	id   = emf_vf.2
	desc = emf_vf.2.desc
	is_triggered_only = yes
	
	option = {
		name = emf_vf.2.opt.a
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_fold
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.10 } }
			}
		}
	}
	
	option = {
		name = emf_vf.2.opt.b
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_deny
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.11 } }
			}
		}
	}
}


# emf_vf.3
# Ultimatum letter from FROM, the faction leader, sent to ROOT, the liege (ai = no)
# Variant: Neutral: Permit us to cooperate autonomously as is our right, or we will resort to force.
letter_event = {
	id   = emf_vf.3
	desc = emf_vf.3.desc
	is_triggered_only = yes
	
	option = {
		name = emf_vf.3.opt.a
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_fold
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.10 } }
			}
		}
	}
	
	option = {
		name = emf_vf.3.opt.b
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_deny
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.11 } }
			}
		}
	}
}


# emf_vf.4
# Ultimatum letter from FROM, the faction leader, sent to ROOT, the liege (ai = no)
# Variant: Negative: Liege is disliked by faction leader.
letter_event = {
	id   = emf_vf.4
	desc = emf_vf.4.desc
	is_triggered_only = yes
	
	option = {
		name = emf_vf.4.opt.a
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_fold
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.10 } }
			}
		}
	}
	
	option = {
		name = emf_vf.4.opt.b
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_deny
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.11 } }
			}
		}
	}
}


# emf_vf.5
# Ultimatum letter from FROM, the faction leader, sent to ROOT, the liege (ai = no)
# Variant: Negative: Liege is hated by faction leader.
letter_event = {
	id   = emf_vf.5
	desc = emf_vf.5.desc
	is_triggered_only = yes
	
	option = {
		name = emf_vf.5.opt.a
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_fold
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.10 } }
			}
		}
	}
	
	option = {
		name = emf_vf.5.opt.b
		custom_tooltip = {
			text = emf_ctt_faction_vf_legalize_cooperation_ultimatum_deny
			hidden_tooltip = {
				FROM = { character_event = { id = emf_vf.11 } }
			}
		}
	}
}


# emf_vf.10
# Proxy event for response to faction_vf_legalize_cooperation ultimatum (accept)
#
# ROOT = faction leader
character_event = {
	id = emf_vf.10
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		liege = {
			any_vassal = {
				limit = {
					ai = no
					not = { in_faction = faction_vf_legalize_cooperation }
				}
				character_event = { id = emf_vf.12 }
			}
		}

		liege = { character_event = { id = emf_vf.13 } } # Notify leader of accepting ultimatum // TODO: Add a few flavor variants
				
		# Remove faction's diplomatic immunity
		any_faction_backer = {
			faction = faction_vf_legalize_cooperation
			letter_event = { emf_vf.15 } # Notify faction member of accepting ultimatum // TODO: Add a few flavor variants
			diplomatic_immunity = no
		}
		diplomatic_immunity = no
		
		# Pass Vassal Cooperation: Allowed
		liege = {
			primary_title = {
				ROOT = {
					liege = {
						any_demesne_title = {
							limit = {
								not = { lower_tier_than = PREVPREVPREV }
							}
							add_law_w_cooldown = vf_cooperation_1
						}
					}
				}
			}
		}
		
		# TODO: Schedule VF leadership election
	}
	
	option = {
		name = OK
	}
}

# emf_vf.11
# Proxy event for response to faction_vf_legalize_cooperation ultimatum (deny)
#
# ROOT = faction leader
character_event = {
	id = emf_vf.11
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				faction_power = { faction = faction_vf_legalize_cooperation power = 1.0 }
			}
			random = {
				chance = 25
				liege = { character_event = { id = 45002 days = 120 } } # Loyalists flock to the liege's banner
			}
		}
		
		liege = { character_event = { id = emf_vf.20 days = 3 } } # Notify leader of ultimatum refusal

		if = {
			limit = {
				not = { faction_power = { faction = faction_vf_legalize_cooperation power = 0.75 } }
			}
			random_list = {
				30 = { }
				30 = {
					character_event = { id = 45000 days = 17 } # A great number of rebels flock to the revolter's banner
				}
				40 = {
					character_event = { id = 45004 days = 17 } # Rebels flock to the revolter's banner
				}
			}
		}
		if = {
			limit = {
				faction_power = { faction = faction_vf_legalize_cooperation power = 0.75 }
				not = { faction_power = { faction = faction_vf_legalize_cooperation power = 1.5 } }
			}
			random_list = {
				50 = { }
				20 = {
					character_event = { id = 45000 days = 17 } # A great number of rebels flock to the revolter's banner
				}
				30 = {
					character_event = { id = 45004 days = 17 } # Rebels flock to the revolter's banner
				}
			}
		}
	}
	
	option = {
		name = OK
	}
}

# emf_vf.12
# Notify faction_vf_legalize_cooperation non-participant of ultimatum acceptance
#
# FROM = faction leader
# ROOT = non-faction member (ai = no)
character_event = {
	id   = emf_vf.12
	desc = emf_vf.12.desc
	is_triggered_only = yes
	
	picture = GFX_evt_council
	border = GFX_event_normal_frame_intrigue
	
	option = {
		name = I_SEE
	}
}

# emf_vf.13
# Bounced notification of faction_vf_legalize_cooperation leader of ultimatum acceptance
#
# FROM = faction leader
# ROOT = liege
character_event = {
	id   = emf_vf.13
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		FROM = { letter_event = { id = emf_vf.14 } }
		
		# TODO: Add more flavor variants here and turn this into a proper proxy event
	}
	
	option = {
		name = OK
	}
}

# emf_vf.14
# Notification of faction_vf_legalize_cooperation leader of ultimatum acceptance
#
# FROM = liege
# ROOT = faction leader
letter_event = {
	id   = emf_vf.14
	desc = emf_vf.14.desc
	is_triggered_only = yes
	
	option = {
		name = EXCELLENT
		clr_character_flag = faction_vf_legalize_cooperation_ultimatum_taken
	}
}


# emf_vf.15
# Notify faction_vf_legalize_cooperation backer of ultimatum acceptance
#
# FROM = faction leader
# ROOT = faction member
letter_event = {
	id   = emf_vf.15
	desc = emf_vf.15.desc
	is_triggered_only = yes
	
	option = {
		name = GOOD
		reverse_opinion = {
			modifier = opinion_grateful
			who = FROM
			years = 5
		}
		
		# TODO: add STOM toward faction leader for successfully getting liege to legalize VF,
		# which will improve their chances for being elected as the first VF leader
	}
}


# emf_vf.20
# Bounced notification of faction_vf_legalize_cooperation leader of ultimatum refusal
#
# FROM = faction leader
# ROOT = liege
character_event = {
	id   = emf_vf.20
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		FROM = { letter_event = { id = emf_vf.21 } }
		
		# TODO: Add more flavor variants here and turn this into a proper proxy event
	}
	
	option = {
		name = OK
	}
}


# emf_vf.21
# Notification of faction_vf_legalize_cooperation leader of ultimatum refusal
#
# FROM = liege
# ROOT = faction leader
letter_event = {
	id   = emf_vf.21
	desc = emf_vf.21.desc
	is_triggered_only = yes
	
	option = {
		name = emf_vf.21.opt.a
		clr_character_flag = faction_vf_legalize_cooperation_ultimatum_taken
		
		FROM = {
			primary_title = {
				reverse_war = {
					target = ROOT
					casus_belli = vf_legalize_cooperation
					faction = faction_vf_legalize_cooperation
				}
			}
		}
	}
}
