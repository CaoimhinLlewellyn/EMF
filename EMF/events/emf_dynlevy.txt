
namespace = emf_dynlevy


# emf_dynlevy.0
# Scenario initialization event for dynlevies subsystem
character_event = {
	id = emf_dynlevy.0
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		# Set initial dynlevy laws for all tier >= count rulers' primary-tier tiles
		any_independent_ruler = {
			if = {
				limit = { higher_tier_than = count }
				character_event = { id = emf_dynlevy.20 }
			}
			any_realm_lord = {
				limit = { higher_tier_than = count }
				character_event = { id = emf_dynlevy.20 }
			}
		}
		
		# Initialize all county titles to maximum levy efficiency
		any_independent_ruler = {
			any_demesne_title = {
				limit = { tier = count }
				add_law = dynlevy_0
			}
			any_realm_lord = {
				any_demesne_title = {
					limit = { tier = count }
					add_law = dynlevy_0
				}
			}
		}
	}
	
	option = { name = OK }
}


# emf_dynlevy.1
# on_new_holder[_usurpation} listeners for triggering dynlevy law updates
#
# Title transfers covered: usurpation, grant
#
# Uses a batch-optimization mechanism: maintains a "dirty" flag for enabling single
# enqueues of the dynlevy.100, the generic law update evaluation event.
#
# Trigger trickles-up law reevaluation to all lieges, if any
character_event = {
	id = emf_dynlevy.1
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		FROMFROM = { is_alive = yes }
		ROOT = { not = { character = FROMFROM } }
	}
	
	immediate = {
		FROMFROM = {
			if = {
				limit = { not = { has_character_flag = dynlevy_dirty } }
				set_character_flag = dynlevy_dirty
				character_event = { id = dynlevy.100 days = 1 }
				
				any_liege = {
					limit = { not = { has_character_flag = dynlevy_dirty } }
					set_character_flag = dynlevy_dirty
					character_event = { id = dynlevy.100 days = 1 }
				}
			}
		}
		
		if = {
			limit = { not = { has_character_flag = dynlevy_dirty } }
			set_character_flag = dynlevy_dirty
			character_event = { id = dynlevy.100 days = 1 }

			any_liege = {
				limit = { not = { has_character_flag = dynlevy_dirty } }
				set_character_flag = dynlevy_dirty
				character_event = { id = dynlevy.100 days = 1 }
			}
		}
	}
	
	option = { name = OK }
}


# emf_dynlevy.2
# on_new_holder_inheritance listener for triggering dynlevy law updates
#
# Title transfers covered: inheritance
#
# Uses a batch-optimization mechanism: maintains a "dirty" flag for enabling single
# enqueues of the dynlevy.100, the generic law update evaluation event.
#
# Trigger trickles-up law reevaluation to all lieges, if any
character_event = {
	id = emf_dynlevy.2
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = { not = { has_character_flag = dynlevy_dirty } }
			set_character_flag = dynlevy_dirty
			character_event = { id = dynlevy.100 days = 1 }

			any_liege = {
				limit = { not = { has_character_flag = dynlevy_dirty } }
				set_character_flag = dynlevy_dirty
				character_event = { id = dynlevy.100 days = 1 }
			}
		}
	}
	
	option = { name = OK }
}


# emf_dynlevy.3
# on_new_holder listener for triggering dynlevy law updates
#
# Title transfers covered: creation of a barony
#
# Uses a batch-optimization mechanism: maintains a "dirty" flag for enabling single
# enqueues of the dynlevy.100, the generic law update evaluation event.
#
# Trigger trickles-up law reevaluation to all lieges, if any
character_event = {
	id = emf_dynlevy.3
	desc = HIDE_EVENT
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		not = { FROMFROM = { always = yes } }
		FROM = { tier = baron }
	}
	
	immediate = {
		if = {
			limit = { not = { has_character_flag = dynlevy_dirty } }
			set_character_flag = dynlevy_dirty
			character_event = { id = dynlevy.100 days = 1 }

			any_liege = {
				limit = { not = { has_character_flag = dynlevy_dirty } }
				set_character_flag = dynlevy_dirty
				character_event = { id = dynlevy.100 days = 1 }
			}
		}
	}
	
	option = { name = OK }
}
